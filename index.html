<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFRD Serial Position Recall Experiment</title>

  <!-- jsPsych CSS -->
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
  
  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  
  <!-- jsPsych Core -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>

  <!-- Custom Styles -->
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #ffffff;
      padding: 20px;
    }
    .jspsych-content {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .passage-container {
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #000000;
      padding: 20px;
      margin-top: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .jspsych-survey-text-question {
      margin-bottom: 20px;
      border: 1px solid #e5e7eb;
      padding: 15px;
      border-radius: 8px;
    }
    .jspsych-btn {
      background-color: #3b82f6;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: background-color 0.2s;
      margin-top: 20px;
    }
    .jspsych-btn:hover { background-color: #2563eb; }
  </style>
</head>

<body>
<div id="jspsych-target"></div>

<script>
// Check if jsPsych loaded
if (typeof initJsPsych === 'undefined') {
  document.getElementById('jspsych-target').innerHTML = '<h1 style="color: red;">Error: jsPsych failed to load. Please check your internet connection.</h1>';
  throw new Error('jsPsych library did not load');
}

const NFRD_SETS = [
  {
    id: 'set_A',
    title: 'Passage Set A: The Antarctic Expedition',
    passage: `
      <div class="passage-container">
        <h3 class="text-xl font-semibold mb-3 text-blue-700">The Discovery of the Antarctic Expedition</h3>
        <p class="mb-4 text-gray-800"><span class="font-bold">Primacy Section:</span> The early expedition set out with the primary goal of reaching the South Pole. They had only five months to complete their journey before the harsh winter would make travel impossible.</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Middle Section:</span> Dr. Finch served as the chief medical officer and often played the harmonica to boost morale during the long, dark nights.</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Recency Section:</span> Eventually, they were rescued by a Chilean tugboat named Yelcho and landed at Grytviken to recover from their ordeal.</p>
        <p class="text-sm text-gray-500">*** End of Passage ***</p>
      </div>
    `,
    questions: [
      { prompt: 'What was the primary goal of the expedition?', required: true, name: 'A_q1', data: { position: 'primacy', correct_answer: 'South Pole'} },
      { prompt: 'How long did they have to complete the journey?', required: true, name: 'A_q2', data: { position: 'primacy', correct_answer: 'five months'} },
      { prompt: 'Who was the chief medical officer?', required: true, name: 'A_q3', data: { position: 'middle', correct_answer: 'Dr. Finch'} },
      { prompt: 'What did the doctor often play?', required: true, name: 'A_q4', data: { position: 'middle', correct_answer: 'harmonica'} },
      { prompt: 'What was the name of the Chilean tugboat?', required: true, name: 'A_q5', data: { position: 'recency', correct_answer: 'Yelcho'} },
      { prompt: 'Where did they land after rescue?', required: true, name: 'A_q6', data: { position: 'recency', correct_answer: 'Grytviken'} }
    ]
  },
  {
    id: 'set_B',
    title: 'Passage Set B: The Ancient Library of Alexandria',
    passage: `
      <div class="passage-container">
        <h3 class="text-xl font-semibold mb-3 text-blue-700">The Glory of the Ancient Library</h3>
        <p class="mb-4 text-gray-800"><span class="font-bold">Primacy Section:</span> The library was founded by Ptolemy I Soter around 300 BCE. Scholars traveled for seven days to reach it.</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Middle Section:</span> Eratosthenes calculated the circumference of Earth and preferred to be called a "lover of wisdom."</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Recency Section:</span> The institution was called the Mouseion and declined around the 4th century CE.</p>
        <p class="text-sm text-gray-500">*** End of Passage ***</p>
      </div>
    `,
    questions: [
      { prompt: 'Who founded the library?', required: true, name: 'B_q1', data:{position:'primacy',correct_answer:'Ptolemy I Soter'} },
      { prompt: 'How many days did scholars travel?', required: true, name: 'B_q2', data:{position:'primacy',correct_answer:'seven'} },
      { prompt: 'What did Eratosthenes calculate?', required: true, name:'B_q3',data:{position:'middle',correct_answer:'circumference of the Earth'} },
      { prompt: 'What title did he prefer?', required:true, name:'B_q4',data:{position:'middle',correct_answer:'lover of wisdom'} },
      { prompt: 'What was the institution called?', required:true,name:'B_q5',data:{position:'recency',correct_answer:'Mouseion'} },
      { prompt: 'Around what century did it decline?', required:true,name:'B_q6',data:{position:'recency',correct_answer:'4th century CE'} }
    ]
  },
  {
    id: 'set_C',
    title: 'Passage Set C: The Invention of the Printing Press',
    passage: `
      <div class="passage-container">
        <h3 class="text-xl font-semibold mb-3 text-blue-700">Gutenberg's Revolution</h3>
        <p class="mb-4 text-gray-800"><span class="font-bold">Primacy Section:</span> Johannes Gutenberg invented the printing press, and the first major text was the Gutenberg Bible.</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Middle Section:</span> The movable type was made from lead, tin, and antimony, allowing correction by replacing individual letters.</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Recency Section:</span> The ink was based on olive oil, and by 1500, presses existed in over 250 cities.</p>
        <p class="text-sm text-gray-500">*** End of Passage ***</p>
      </div>
    `,
    questions: [
      { prompt:'Who invented the printing press?', required:true, name:'C_q1', data:{position:'primacy',correct_answer:'Johannes Gutenberg'} },
      { prompt:'What was the first major work printed?', required:true,name:'C_q2',data:{position:'primacy',correct_answer:'Gutenberg Bible'} },
      { prompt:'What metals were used for movable type?', required:true,name:'C_q3',data:{position:'middle',correct_answer:'lead, tin, and antimony'} },
      { prompt:'What allowed correction in printing?', required:true,name:'C_q4',data:{position:'middle',correct_answer:'replacing individual letters'} },
      { prompt:'What was the ink base?', required:true,name:'C_q5',data:{position:'recency',correct_answer:'olive oil'} },
      { prompt:'How many cities had presses by 1500?', required:true,name:'C_q6',data:{position:'recency',correct_answer:'over 250'} }
    ]
  },
  {
    id: 'set_D',
    title: 'Passage Set D: The Construction of the Panama Canal',
    passage: `
      <div class="passage-container">
        <h3 class="text-xl font-semibold mb-3 text-blue-700">Connecting the Oceans</h3>
        <p class="mb-4 text-gray-800"><span class="font-bold">Primacy Section:</span> The French were first to attempt construction, led by Ferdinand de Lesseps, attempting a sea-level canal.</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Middle Section:</span> Disease was the primary obstacle. Colonel William C. Gorgas implemented mosquito control measures.</p>
        <p class="mb-4 text-gray-800"><span class="font-bold">Recency Section:</span> The Gatun Locks raised ships 85 feet, and the first vessel through was the SS Ancon.</p>
        <p class="text-sm text-gray-500">*** End of Passage ***</p>
      </div>
    `,
    questions: [
      { prompt:'Who led the French attempt?',required:true,name:'D_q1',data:{position:'primacy',correct_answer:'Ferdinand de Lesseps'}},
      { prompt:'What kind of canal did they attempt?',required:true,name:'D_q2',data:{position:'primacy',correct_answer:'sea-level canal'}},
      { prompt:'Who implemented mosquito control?',required:true,name:'D_q3',data:{position:'middle',correct_answer:'Colonel William C. Gorgas'}},
      { prompt:'What was the primary obstacle?',required:true,name:'D_q4',data:{position:'middle',correct_answer:'disease'}},
      { prompt:'How many feet did the Gatun Locks raise ships?',required:true,name:'D_q5',data:{position:'recency',correct_answer:'85 feet'}},
      { prompt:'What was the first vessel through?',required:true,name:'D_q6',data:{position:'recency',correct_answer:'SS Ancon'}}
    ]
  }
];

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function create_distractor_block(set_id) {
  const math_problems = [];
  for (let i = 0; i < 10; i++) {
    const n1 = randInt(10, 99);
    const n2 = randInt(10, 99);
    math_problems.push({
      prompt: `<p class="text-lg">What is the sum of ${n1} and ${n2}?</p>`,
      name: `math_${i}`,
      placeholder: ""
    });
  }

  return {
    type: jsPsychSurveyText,
    questions: math_problems,
    preamble: `
      <h2 class="text-2xl font-bold text-red-600">3-Minute Distractor Task</h2>
      <p>Solve as many math problems as you can.</p>
    `,
    trial_duration: 180000,
    data: {block_type:"distractor", set:set_id}
  };
}

function create_full_trial_sequence(set_data) {
  const reading_block = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <h1 class="text-3xl font-bold mb-4">${set_data.title}</h1>
      <p class="text-gray-500 mb-2">Press SPACE when finished reading.</p>
      ${set_data.passage}
    `,
    choices: [" "],
    data: { block_type:"reading", set:set_data.id }
  };

  const question_block = {
    type: jsPsychSurveyText,
    questions: set_data.questions,
    preamble: `
      <h2 class="text-2xl font-bold text-red-700 mb-3">Recall Test</h2>
      <p class="mb-4">Answer from memory only.</p>
    `,
    button_label: "Submit Answers",
    data: { block_type:"questions", set:set_data.id }
  };

  return {
    timeline: [
      reading_block,
      create_distractor_block(set_data.id),
      question_block
    ]
  };
}

const jsPsych = initJsPsych({
  display_element: "jspsych-target",
  on_finish: () => {
    // Get all data
    const data = jsPsych.data.get();
    
    // Filter for just the question responses
    const responses = data.filter({block_type: 'questions'});
    
    // Prepare data to send
    const dataToSend = {
      participant_id: 'P' + Date.now(),
      timestamp: new Date().toISOString(),
      set1: selected_sets[0].id,
      set2: selected_sets[1].id
    };
    
    // Add all responses
    responses.values().forEach(trial => {
      if (trial.response) {
        Object.keys(trial.response).forEach(key => {
          dataToSend[key] = trial.response[key];
        });
      }
    });
    
    // Send to Google Sheets
    const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE'; // Replace with your script URL
    
    fetch(SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(dataToSend)
    }).then(() => {
      // Also save locally as backup
      data.localSave("csv", "serial_position_data.csv");
    }).catch(error => {
      console.error('Error sending data:', error);
      // Save locally if sending fails
      data.localSave("csv", "serial_position_data.csv");
    });
  }
});

const selected_sets = jsPsych.randomization.sampleWithoutReplacement(NFRD_SETS, 2);

const timeline = [
  {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: "<h1 class='text-3xl font-bold mb-4'>Welcome!</h1><p class='text-lg'>Press any key to continue.</p>"
  },
  {
    type: jsPsychHtmlKeyboardResponse,
    choices: [" "],
    stimulus: `
      <h2 class="text-2xl font-bold mb-4">Instructions</h2>
      <p class="mb-3">You will read two passages and answer recall questions.</p>
      <p>Press SPACE to begin.</p>
    `
  },
  create_full_trial_sequence(selected_sets[0]),
  {
    type: jsPsychHtmlKeyboardResponse,
    choices: [" "],
    stimulus: `<h2 class="text-xl font-bold text-green-600 mb-3">Passage 1 Complete</h2><p>Press SPACE for Passage 2.</p>`
  },
  create_full_trial_sequence(selected_sets[1]),
  {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<h2 class="text-2xl font-bold text-green-700 mb-3">Thank you!</h2><p>The experiment is complete. Your data has been saved.</p>`
  }
];

jsPsych.run(timeline);
</script>
</body>
</html>